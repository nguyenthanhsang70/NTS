<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bể Cá 3D Pro - NTS</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
  body, html {
    margin: 0;
    padding: 0;
    overflow: hidden;
    width: 100%;
    height: 100%;
    background-color: #001e36; /* Màu nền cơ bản */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  canvas {
    display: block;
  }

  /* Giao diện điều khiển đẹp hơn */
  .controls {
    position: absolute;
    top: 20px;
    left: 20px;
    display: flex;
    gap: 15px;
    z-index: 100;
  }

  .btn {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 20px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }

  .btn:hover {
    background: rgba(255, 255, 255, 0.4);
    transform: scale(1.1);
  }

  .btn:active {
    transform: scale(0.95);
  }

  /* Tooltip */
  .btn::after {
    content: attr(data-tooltip);
    position: absolute;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    white-space: nowrap;
  }

  .btn:hover::after {
    opacity: 1;
  }

</style>
</head>
<body>

<div class="controls">
  <button class="btn" onclick="window.location.href='index.html'" data-tooltip="Quay lại"><i class="fas fa-arrow-left"></i></button>
  <button class="btn" onclick="toggleDayNight()" id="btnTheme" data-tooltip="Ngày/Đêm"><i class="fas fa-sun"></i></button>
  <button class="btn" onclick="toggleMusic()" id="btnMusic" data-tooltip="Âm nhạc"><i class="fas fa-music"></i></button>
</div>

<canvas id="aquarium"></canvas>

<script>
const canvas = document.getElementById('aquarium');
const ctx = canvas.getContext('2d');

// Thiết lập kích thước
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// Cấu hình
let isDay = true;
let audioEnabled = false;

// Gradient màu nước
const dayWater = ['#1e90ff', '#87cefa', '#b0e0e6'];
const nightWater = ['#000033', '#000066', '#191970'];

// Âm thanh (Xử lý lỗi nếu không có file)
const bgMusic = new Audio('bien.mp3'); // Nhạc nền
const eatSound = new Audio('caan.mp3'); // Tiếng ăn
bgMusic.loop = true;

function toggleMusic() {
  audioEnabled = !audioEnabled;
  const btn = document.getElementById('btnMusic');
  if (audioEnabled) {
    btn.innerHTML = '<i class="fas fa-volume-up"></i>';
    btn.style.background = 'rgba(100, 255, 100, 0.4)';
    bgMusic.play().catch(e => console.log("Chưa có file nhạc bien.mp3"));
  } else {
    btn.innerHTML = '<i class="fas fa-music"></i>';
    btn.style.background = '';
    bgMusic.pause();
  }
}

function playEatSound() {
  if (audioEnabled) {
    // Clone node để có thể phát chồng âm thanh liên tục
    const sound = eatSound.cloneNode();
    sound.play().catch(e => {});
  }
}

function toggleDayNight() {
  isDay = !isDay;
  const btn = document.getElementById('btnTheme');
  if (isDay) {
    btn.innerHTML = '<i class="fas fa-sun"></i>';
  } else {
    btn.innerHTML = '<i class="fas fa-moon"></i>';
  }
}

// --- OBJECTS ---

// Hiệu ứng gợn sóng khi click
let ripples = [];
function Ripple(x, y) {
    this.x = x;
    this.y = y;
    this.radius = 0;
    this.alpha = 1;
    this.lineWidth = 2;
}
Ripple.prototype.update = function() {
    this.radius += 2;
    this.alpha -= 0.02;
    this.lineWidth -= 0.02;
}
Ripple.prototype.draw = function() {
    ctx.save();
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.strokeStyle = `rgba(255, 255, 255, ${this.alpha})`;
    ctx.lineWidth = Math.max(0.1, this.lineWidth);
    ctx.stroke();
    ctx.restore();
}

// Cá (Cải tiến hình dáng và chuyển động)
function Fish(x, y, size, color) {
  this.x = x;
  this.y = y;
  this.size = size;
  this.baseColor = color;
  this.speed = Math.random() * 1.5 + 0.5;
  this.angle = Math.random() * Math.PI * 2;
  this.targetX = null;
  this.targetY = null;
  this.wiggleOffset = Math.random() * 100;
}

Fish.prototype.draw = function() {
  ctx.save();
  ctx.translate(this.x, this.y);
  
  // Xoay cá theo hướng di chuyển nhưng mượt hơn
  // Nếu cá đang bơi sang trái (angle > PI/2 && angle < 3*PI/2), lật ngược lại để bụng luôn ở dưới
  let drawAngle = this.angle;
  if (Math.abs(Math.cos(this.angle)) < 0.1) {
      // Tránh lật liên tục khi đi thẳng đứng
  }
  
  ctx.rotate(drawAngle);

  // Tạo hiệu ứng động cho đuôi
  const wiggle = Math.sin(Date.now() / 150 + this.wiggleOffset) * 0.15;

  // Bóng đổ
  ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
  ctx.shadowBlur = 15;
  ctx.shadowOffsetY = 10;

  // Thân cá (Gradient đẹp hơn)
  const grad = ctx.createLinearGradient(-this.size, 0, this.size, 0);
  grad.addColorStop(0, this.baseColor);
  grad.addColorStop(1, 'white');
  
  ctx.fillStyle = grad;
  ctx.beginPath();
  // Vẽ thân dạng hình giọt nước bầu dục
  ctx.ellipse(0, 0, this.size, this.size / 2.2, 0, 0, Math.PI * 2);
  ctx.fill();

  // Reset bóng cho các chi tiết
  ctx.shadowBlur = 0;
  ctx.shadowOffsetY = 0;

  // Đuôi cá
  ctx.fillStyle = this.baseColor;
  ctx.beginPath();
  ctx.moveTo(-this.size + 5, 0);
  ctx.lineTo(-this.size * 1.6, -this.size / 1.5 + wiggle * 20);
  ctx.lineTo(-this.size * 1.6, this.size / 1.5 + wiggle * 20);
  ctx.closePath();
  ctx.fill();

  // Vây bên (Side Fin) - Hiệu ứng vẫy
  const finWiggle = Math.cos(Date.now() / 100 + this.wiggleOffset) * 0.2;
  ctx.fillStyle = 'rgba(255,255,255,0.6)';
  ctx.beginPath();
  ctx.ellipse(0, this.size/4, this.size/4, this.size/8, Math.PI/4 + finWiggle, 0, Math.PI*2);
  ctx.fill();

  // Mắt
  ctx.fillStyle = 'white';
  ctx.beginPath();
  ctx.arc(this.size / 1.5, -this.size / 6, this.size / 8, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = 'black';
  ctx.beginPath();
  ctx.arc(this.size / 1.5 + 1, -this.size / 6, this.size / 16, 0, Math.PI * 2);
  ctx.fill();

  ctx.restore();
};

Fish.prototype.update = function() {
  // Nếu có thức ăn
  if (this.targetX !== null && this.targetY !== null) {
    const dx = this.targetX - this.x;
    const dy = this.targetY - this.y;
    const distance = Math.sqrt(dx * dx + dy * dy);
    
    // Góc mục tiêu
    const targetAngle = Math.atan2(dy, dx);
    
    // Xoay từ từ về phía mục tiêu (Smooth Turn)
    let diff = targetAngle - this.angle;
    while (diff < -Math.PI) diff += Math.PI * 2;
    while (diff > Math.PI) diff -= Math.PI * 2;
    this.angle += diff * 0.05;

    if (distance > 10) {
      // Tăng tốc khi thấy mồi
      this.x += Math.cos(this.angle) * (this.speed * 2);
      this.y += Math.sin(this.angle) * (this.speed * 2);
    } else {
      // Đã ăn xong
      this.targetX = null;
      this.targetY = null;
      playEatSound();
    }
  } else {
    // Bơi tự do
    this.x += Math.cos(this.angle) * this.speed;
    this.y += Math.sin(this.angle) * this.speed;

    // Đổi hướng ngẫu nhiên nhẹ nhàng
    this.angle += (Math.random() - 0.5) * 0.05;

    // Phản xạ khi gặp tường
    const padding = 50;
    if (this.x < padding) this.angle = 0 + Math.random();
    if (this.x > canvas.width - padding) this.angle = Math.PI + Math.random();
    if (this.y < padding) this.angle = Math.PI/2 + Math.random();
    if (this.y > canvas.height - padding) this.angle = -Math.PI/2 - Math.random();
  }
};

const fishes = [];
for (let i = 0; i < 40; i++) {
  const hue = Math.random() * 360;
  const color = `hsl(${hue}, 80%, 50%)`;
  fishes.push(new Fish(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 15 + 10, color));
}

// Thức ăn
let feedParticles = [];
function FeedParticle(x, y) {
  this.x = x;
  this.y = y;
  this.size = Math.random() * 4 + 2;
  this.vy = Math.random() * 1 + 1; // Tốc độ rơi
  this.vx = (Math.random() - 0.5) * 1; // Lắc lư ngang
  this.life = 1;
}
FeedParticle.prototype.draw = function() {
  ctx.fillStyle = `rgba(255, 165, 0, ${this.life})`;
  ctx.beginPath();
  ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
  ctx.fill();
};
FeedParticle.prototype.update = function() {
  this.y += this.vy;
  this.x += Math.sin(this.y / 50) * 0.5; // Rơi lắc lư
  this.life -= 0.002; // Tan biến dần
};

// Bong bóng
const bubbles = [];
function Bubble() {
  this.x = Math.random() * canvas.width;
  this.y = canvas.height + Math.random() * 100;
  this.size = Math.random() * 5 + 2;
  this.speed = Math.random() * 2 + 1;
  this.wobble = Math.random() * Math.PI * 2;
}
Bubble.prototype.update = function() {
  this.y -= this.speed;
  this.wobble += 0.05;
  this.x += Math.sin(this.wobble) * 1;
  if (this.y < -10) this.y = canvas.height + Math.random() * 100;
};
Bubble.prototype.draw = function() {
  ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
  ctx.fill();
  ctx.stroke();
  // Điểm sáng trên bong bóng
  ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
  ctx.beginPath();
  ctx.arc(this.x - this.size/3, this.y - this.size/3, this.size/4, 0, Math.PI * 2);
  ctx.fill();
};
for(let i=0; i<30; i++) bubbles.push(new Bubble());

// Rong biển (Seaweed)
const seaweeds = [];
function initSeaweed() {
    seaweeds.length = 0; // Clear old
    const count = Math.floor(canvas.width / 40);
    for(let i=0; i<count; i++) {
        seaweeds.push({
            x: i * 40 + (Math.random()-0.5)*20,
            height: 100 + Math.random() * 150,
            color: Math.random() > 0.5 ? '#228B22' : '#2E8B57',
            segments: 5,
            offset: Math.random() * Math.PI * 2
        });
    }
}
initSeaweed();
window.addEventListener('resize', initSeaweed);

function drawSeaweed() {
    const time = Date.now() / 1000;
    seaweeds.forEach(sw => {
        ctx.strokeStyle = sw.color;
        ctx.lineWidth = 8;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(sw.x, canvas.height);
        
        let currentX = sw.x;
        let currentY = canvas.height;
        const segmentH = sw.height / sw.segments;

        for(let i=0; i<sw.segments; i++) {
            // Tạo chuyển động sóng
            const sway = Math.sin(time + sw.offset + i) * (i * 2); 
            currentX += sway;
            currentY -= segmentH;
            ctx.lineTo(currentX, currentY);
        }
        ctx.stroke();
    });
}

// Tia nắng (God Rays)
function drawSunbeams() {
    if (!isDay) return; // Chỉ hiện vào ban ngày
    ctx.save();
    ctx.globalCompositeOperation = 'overlay';
    const time = Date.now() / 2000;
    
    // Vẽ 3 chùm tia
    for(let i=0; i<3; i++) {
        const gradient = ctx.createLinearGradient(canvas.width/2 + (i-1)*200, -100, canvas.width/2 + (i-1)*300 + Math.sin(time)*100, canvas.height);
        gradient.addColorStop(0, 'rgba(255, 255, 255, 0.2)');
        gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.05)');
        gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
        
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2 + (i-1)*50 - 100, -100);
        ctx.lineTo(canvas.width/2 + (i-1)*50 + 100, -100);
        ctx.lineTo(canvas.width/2 + (i-1)*400 + 300 + Math.sin(time+i)*50, canvas.height);
        ctx.lineTo(canvas.width/2 + (i-1)*400 - 300 + Math.sin(time+i)*50, canvas.height);
        ctx.fill();
    }
    ctx.restore();
}

// Vẽ nền (Cát và Nước)
function drawBackground() {
  // Nước
  const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
  const colors = isDay ? dayWater : nightWater;
  gradient.addColorStop(0, colors[0]);
  gradient.addColorStop(0.5, colors[1]);
  gradient.addColorStop(1, colors[2]);
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Cát
  const sandGrad = ctx.createLinearGradient(0, canvas.height - 80, 0, canvas.height);
  sandGrad.addColorStop(0, isDay ? '#E6C288' : '#4b3621'); // Cát tối đi khi đêm xuống
  sandGrad.addColorStop(1, isDay ? '#C19A6B' : '#2f1f10');
  ctx.fillStyle = sandGrad;
  
  ctx.beginPath();
  ctx.moveTo(0, canvas.height - 50);
  // Tạo bề mặt cát gợn sóng
  for(let i=0; i<=canvas.width; i+=50) {
      ctx.lineTo(i, canvas.height - 60 + Math.sin(i/100)*20);
  }
  ctx.lineTo(canvas.width, canvas.height);
  ctx.lineTo(0, canvas.height);
  ctx.fill();
}

// MAIN LOOP
function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  drawBackground();
  drawSunbeams();
  drawSeaweed();
  
  // Xử lý thức ăn
  feedParticles = feedParticles.filter(p => p.life > 0 && p.y < canvas.height - 50);
  feedParticles.forEach(p => {
      p.update();
      p.draw();
  });

  // Xử lý cá
  fishes.forEach(fish => {
    fish.update();
    fish.draw();
  });

  // Xử lý bong bóng
  bubbles.forEach(b => {
      b.update();
      b.draw();
  });

  // Xử lý gợn sóng
  ripples = ripples.filter(r => r.alpha > 0);
  ripples.forEach(r => {
      r.update();
      r.draw();
  });

  requestAnimationFrame(animate);
}

// Tương tác chuột/cảm ứng
function handleInput(x, y) {
    // Tạo gợn sóng
    ripples.push(new Ripple(x, y));

    // Thả thức ăn
    for(let i=0; i<5; i++) {
        feedParticles.push(new FeedParticle(x + (Math.random()-0.5)*30, y));
    }

    // Thu hút cá
    fishes.forEach(fish => {
        // Chỉ những con cá ở gần mới chạy lại (cho tự nhiên)
        const dx = fish.x - x;
        const dy = fish.y - y;
        if (Math.sqrt(dx*dx + dy*dy) < 500) {
            fish.targetX = x + (Math.random()-0.5)*100; // Tản ra xíu, không bu lại 1 điểm
            fish.targetY = y + (Math.random()-0.5)*100;
        }
    });
}

canvas.addEventListener('mousedown', e => handleInput(e.clientX, e.clientY));
canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    handleInput(e.touches[0].clientX, e.touches[0].clientY);
}, {passive: false});

animate();

</script>
</body>
</html>
